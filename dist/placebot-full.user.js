// ==UserScript==
// @name        PlaceBot
// @version     0.0.7
// @namespace   https://github.com/grind086/PlaceBot
// @description A bot that automates drawing on reddit.com/r/place
// @grant       unsafeWindow
// @include     http://www.reddit.com/r/place/
// @include     https://www.reddit.com/r/place/
// ==/UserScript==

(function() {
!function(t){"use strict";var e=function(){this.placeMode=e.placeMode.ARRAY,this.tiles=[],this.tileSelector=e.selector.TopDown,this._tileGeneratorFactory=void 0,this.tileGenerator=void 0,this.drawTimer=void 0,this.minTimer=100,this.lastDrawTime=0,console.log(["------------",,"PlaceBot "+e.version,"------------"].join("\n")),this.load(),this._setTimer()};Object.defineProperties(e.prototype,{cooldownRemaining:{get:function(){return this.nextDrawTime-Date.now()}},nextDrawTime:{get:function(){return e.place.cooldownEndTime}},canDraw:{get:function(){return this.cooldownRemaining<0&&this.lastDrawTime!==this.nextDrawTime}}}),e.version="0.0.7",e.placeMode={ARRAY:0,FUNCTION:1},e.selector={TopDown:function(t){var e=-1,o=1/0,i=1/0;return t.forEach(function(t,s){(t[1]<i||t[1]===i&&t[0]<o)&&(e=s,o=t[0],i=t[1])}),e},BottomUp:function(t){var e=-1,o=-1,i=-1;return t.forEach(function(t,s){(t[1]>i||t[1]===i&&t[0]>o)&&(e=s,o=t[0],i=t[1])}),e},Random:function(t){return Math.floor(Math.random()*t.length)},DrawOrder:function(t){return 0}},e.place=t.r.place,e.placeModules={};var o=["api"];t.r.placeModule("",function(t){o.forEach(function(o){e.placeModules[o]=t(o)})}),t.PlaceBot=e,setTimeout(function(){t.placeBot=new e},0)}("undefined"!=typeof unsafeWindow?unsafeWindow:"undefined"!=typeof window?window:{}),function(global){"use strict";var PlaceBot=global.PlaceBot,localStorage=global.hasOwnProperty("localStorage")?global.localStorage:{getItem:function(){return null},setItem:function(){}};PlaceBot.prototype._importObject=function(t){if("string"==typeof t)try{t=JSON.parse(t)}catch(t){return{success:!1,error:t.message}}return{success:!0,data:t}},PlaceBot.prototype._importFunction=function(data){if("string"==typeof data)try{data=eval("("+data+")")}catch(t){return{success:!1,error:t.message}}return"function"!=typeof data?{success:!1,error:"Invalid data type"}:{success:!0,data:data}},PlaceBot.prototype._tilesObject=function(){var t={mode:this.placeMode,tiles:this.tiles};if(this.placeMode===PlaceBot.placeMode.ARRAY){var e=this.tileSelector.name;PlaceBot.selector.hasOwnProperty(this.tileSelector.name)?t.fn=e:t.fn=this.tileSelector.toString()}else this.placeMode===PlaceBot.placeMode.FUNCTION&&(t.fn=this._tileGeneratorFactory.toString());return t},PlaceBot.prototype._settingsObject=function(){return{minTimer:this.minTimer}},PlaceBot.prototype.exportTiles=function(){return JSON.stringify(this._tilesObject())},PlaceBot.prototype.exportSettings=function(){return JSON.stringify(this._settingsObject())},PlaceBot.prototype.exportBot=function(){return JSON.stringify({settings:this._settingsObject(),tiles:this.tiles})},PlaceBot.prototype.importTiles=function(t){var e=this._importObject(t);if(!e.success)return console.log("Failed to import tiles: %s",e.error),!1;var o=Object.assign(this._tilesObject(),e.data);this.tiles=o.tiles||[],this.setTileFunction(o.mode,o.fn)},PlaceBot.prototype.importSettings=function(t){var e=this._importObject(t);if(!e.success)return console.log("Failed to import settings: %s",e.error),!1;var o=Object.assign(this._settingsObject(),e.data);this.minTimer=o.minTimer},PlaceBot.prototype.importBot=function(t){var e=this._importObject(t);if(!e.success)return console.log("Failed to import bot: %s",e.error),!1;this.importSettings(e.data.settings),this.importTiles(e.data.tiles)},PlaceBot.prototype.save=function(){localStorage.setItem("placebot_settings",this.exportSettings()),localStorage.setItem("placebot_tiles",this.exportTiles())},PlaceBot.prototype.load=function(){this.importSettings(localStorage.getItem("placebot_settings")),this.importTiles(localStorage.getItem("placebot_tiles"))},PlaceBot.prototype.setTileFunction=function(t,e){var o;switch(t){case PlaceBot.placeMode.ARRAY:this.placeMode=PlaceBot.placeMode.ARRAY,this.tileGenerator=void 0,"string"==typeof e&&PlaceBot.selector.hasOwnProperty(e)?this.tileSelector=PlaceBot.selector[e]:(o=this._importFunction(e),o.success?this.tileSelector=o.data:this.tileSelector=PlaceBot.selector.TopDown);break;case PlaceBot.placeMode.FUNCTION:if(this.placeMode=PlaceBot.placeMode.FUNCTION,this.tileSelector=void 0,o=this._importFunction(e),o.success){this._tileGeneratorFactory=o.data,this.tileGenerator=o.data(this);break}console.log("Function import failed: %s",o.error);default:this.tiles=[],this.setTileFunction(PlaceBot.placeMode.ARRAY,"TopDown")}}}("undefined"!=typeof unsafeWindow?unsafeWindow:"undefined"!=typeof window?window:{}),function(t){"use strict";var e=t.PlaceBot;e.prototype._setTimer=function(){clearTimeout(this.drawTimer);var t=Math.round(Math.max(this.minTimer,this.cooldownRemaining));this.drawTimer=setTimeout(this.drawNext.bind(this),t),console.log("Scheduled draw in %sms",t)},e.prototype.drawNext=function(){if(this.canDraw){var t;if(this.placeMode===e.placeMode.ARRAY){if(this.tiles.length){var o=this.tileSelector(this.tiles);t=this.tiles.splice(o,1)[0]}}else this.placeMode===e.placeMode.FUNCTION&&(t=this.tileGenerator());t?(e.placeModules.api.getPixelInfo(t[0],t[1]).then(function(e){e.color!==t[2]?this.drawTile.apply(this,t):console.log("Redundant draw. Skipping."),this._setTimer()}.bind(this)),this.save()):console.log("No tile provided.")}else console.log("Drawing not allowed. Rescheduling.");this._setTimer()},e.prototype.drawTile=function(t,o,i){this.canDraw&&(this.lastDrawTime=this.nextDrawTime,e.place.setColor(i),e.place.drawTile(t,o),console.log("Drawing %s at (%s, %s)",e.place.palette[i],t,o))}}("undefined"!=typeof unsafeWindow?unsafeWindow:"undefined"!=typeof window?window:{});
})();